<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title></title>
        <link rel="stylesheet" th:href="@{/css/execute_order.css}">
        <link rel="stylesheet" th:href="@{/css/product_search_fragment.css}">
    </head>
    <body>
        <div th:insert="~{fragments/navigate :: navigate}"></div>
        <div th:replace="~{fragments/product_search_fragment :: product_search_fragment}"></div>

        <div>
            <form th:action="@{${searchAction}}" method="get" class="search-form">


                <select class="form-control-mobile" id="purchaseStatus" name="purchaseStatus">
                    <option value="all">Все</option>
                    <option value="purchased">Куплено</option>
                    <option value="notPurchased">Не куплено</option>
                </select>

                <button type="submit" class="search-btn">поиск</button>
            </form>
        </div>

        <div class="positions-container">
            <div class="position-card" th:each="position : ${positions}">

                <div class="position-header">
                    <img th:src="@{${position.product.img}}" class="position-image" 
                         th:alt="${position.product.name}" 
                         onerror="this.style.display='none'">

                    <div class="position-info">
                        <div class="product-name" 
                             th:text="${position.product.name + ' ' + position.product.variety}">
                        </div>
                        <div class="product-details" 
                             th:text="${position.product.country}">
                        </div>
                        <div class="position-details" 
                             th:text="'Количество: ' + ${position.quantity}">
                        </div>
                        <div class="position-details" 
                             th:text="'Покупатель: ' + ${position.consumer}" 
                             th:if="${position.consumer != null}">
                        </div>
                    </div>
                </div>

                <form th:action="@{/execute/switch_checkbox}" method="post" class="checkbox-form">
                    <input type="hidden" name="id" th:value="${position.id}">
                    <div class="checkbox-container">
                        <input type="checkbox" th:checked="${position.purchased}" 
                               onchange="this.form.submit()">
                        <span th:text="${position.purchased} ? 'Куплено' : 'Не куплено'"></span>
                    </div>
                </form>

                <form th:action="@{/execute/update(orderId=${orderId})}" method="post" 
                      th:object="${position}" class="data-form">
                    <input type="hidden" name="id" th:value="${position.id}">
                    <input type="hidden" name="orderId" th:value="${orderId}">

                    <div class="form-grid">
                        <div class="input-group">
                            <input type="number" name="buyingPrice" placeholder="0.00" step="0.01"
                                   th:value="${position.buyingPrice != null} ? ${#numbers.formatDecimal(position.buyingPrice, 1, 2)} : ''">
                            <span class="input-label">Цена руб/кг</span>
                        </div>

                        <div class="input-group">
                            <input type="number" name="purchasedQuantity" step="0.001" placeholder="0.000"
                                   th:value="${position.purchasedQuantity > 0} ? ${#numbers.formatDecimal(position.purchasedQuantity, 1, 3)} : ''">
                            <span class="input-label">Вес кг</span>
                        </div>

                        <div class="input-group">
                            <input type="number" name="purchaseAmount" placeholder="0.00" step="0.01"
                                   th:value="${position.purchaseAmount != null} ? ${#numbers.formatDecimal(position.purchaseAmount, 1, 2)} : ''">
                            <span class="input-label">Сумма ₽</span>
                        </div>
                    </div>

                    <button type="submit" class="save-btn">Сохранить</button>
                </form>

            </div>
        </div>


        <div th:insert="~{fragments/footer-fragment :: footer-fragment}"></div>
    </body>
</html>